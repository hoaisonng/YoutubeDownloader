<Window
    x:Class="YoutubeDownloaderWpf.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:YoutubeDownloaderWpf.ViewModels"
    Title="Youtube Downloader Pro"
    Width="950"
    Height="650"
    mc:Ignorable="d">

    <d:Window.DataContext>
        <vm:MainViewModel />
    </d:Window.DataContext>

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
    </Window.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Border
            Grid.Row="0"
            Margin="0,0,0,10"
            Padding="10"
            Background="#FFF4E5"
            BorderBrush="#FFCC80"
            BorderThickness="1"
            CornerRadius="5"
            Visibility="{Binding AreToolsMissing, Converter={StaticResource BoolToVis}}">
            <StackPanel>
                <TextBlock
                    Margin="0,0,0,5"
                    FontWeight="Bold"
                    Foreground="#D32F2F"
                    Text="⚠️ CẢNH BÁO: Ứng dụng thiếu các file thư viện cần thiết để chạy!" />
                <TextBlock Margin="0,0,0,10" Text="{Binding ToolStatusMessage}" />

                <StackPanel Orientation="Horizontal">
                    <Button
                        Margin="0,0,10,0"
                        Padding="10,5"
                        Background="#4CAF50"
                        Command="{Binding DownloadMissingToolsCommand}"
                        Content="Tải Tự Động (Khuyên dùng)"
                        FontWeight="Bold"
                        Foreground="White" />

                    <TextBlock
                        Margin="10,0,5,0"
                        VerticalAlignment="Center"
                        Text="Hoặc chọn file có sẵn:" />
                    <Button
                        Margin="5,0"
                        Command="{Binding LocateYtDlpCommand}"
                        Content="Chọn yt-dlp.exe" />
                    <Button
                        Margin="5,0"
                        Command="{Binding LocateFfmpegCommand}"
                        Content="Chọn ffmpeg.exe" />
                </StackPanel>

                <ProgressBar
                    Height="5"
                    Margin="0,10,0,0"
                    Maximum="100"
                    Visibility="{Binding IsBusyWithTools, Converter={StaticResource BoolToVis}}"
                    Value="{Binding ToolDownloadProgress}" />
            </StackPanel>
        </Border>

        <GroupBox
            Grid.Row="1"
            Padding="10"
            Header="Cấu hình tải">
            <!--<StackPanel>
                <Grid Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBox Text="{Binding InputUrl, UpdateSourceTrigger=PropertyChanged}"
                             FontSize="14" Padding="5" ToolTip="Nhập link Youtube Video hoặc Playlist"/>
                    <Button Content="Thêm vào hàng đợi" Command="{Binding AddDownloadCommand}"
                            Margin="10,0,0,0" Padding="15,5" FontWeight="Bold"/>
                </Grid>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <CheckBox Content="Tải kèm Subtitle" IsChecked="{Binding IsDownloadingSubtitles}"
                              VerticalAlignment="Center" Margin="0,0,20,0"/>

                    <TextBlock Text="Cookies:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <TextBox Text="{Binding CookieFilePath}" Width="150" IsReadOnly="True" VerticalAlignment="Center"/>
                    <Button Content="..." Command="{Binding SelectCookieFileCommand}" Width="30" Margin="5,0,0,0"/>

                    <Button Content="Cập nhật yt-dlp" Command="{Binding UpdateToolsCommand}" Margin="20,0,0,0"
                            IsEnabled="{Binding AreToolsMissing, Converter={StaticResource BoolToVis}, ConverterParameter=Invert}"/>
                    <Button Content="Xóa/Hủy All" Command="{Binding CancelAllCommand}" Margin="10,0,0,0" Background="#FFEBEE"/>
                </StackPanel>
            -->
            <!--</StackPanel>-->
            <StackPanel Grid.Row="1">
                <Grid Margin="0,0,0,5">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBox
                        Grid.Column="0"
                        Padding="5"
                        Text="{Binding InputUrl}"
                        ToolTip="Nhập URL video lẻ" />
                    <Button
                        Grid.Column="1"
                        Width="100"
                        Margin="5,0,0,0"
                        Padding="10,5"
                        Command="{Binding AddDownloadCommand}"
                        Content="Thêm Video Lẻ" />
                </Grid>
                <Grid Margin="0,5">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBlock
                        Margin="0,0,5,0"
                        VerticalAlignment="Center"
                        FontWeight="Bold"
                        Text="Lưu tại:" />

                    <TextBox
                        Grid.Column="1"
                        Padding="5"
                        VerticalAlignment="Center"
                        Background="#F5F5F5"
                        IsReadOnly="True"
                        Text="{Binding OutputFolderPath}" />

                    <Button
                        Grid.Column="2"
                        Margin="5,0,0,0"
                        Padding="10,5"
                        Command="{Binding ChangeOutputFolderCommand}"
                        Content="Thay đổi..." />
                </Grid>
                <StackPanel Margin="0,5" Orientation="Horizontal">
                    <Button
                        Margin="0,0,15,0"
                        Padding="10,5"
                        Background="#E3F2FD"
                        Command="{Binding OpenPlaylistCommand}"
                        Content="📂 Tải Playlist" />

                    <Button
                        Margin="0,0,15,0"
                        Padding="10,5"
                        Background="#FFF3E0"
                        Command="{Binding OpenLoginCommand}"
                        Content="🔑 Đăng nhập (Member)" />

                    <Border
                        Margin="0,0,15,0"
                        Padding="5,0"
                        VerticalAlignment="Center"
                        BorderBrush="Gray"
                        BorderThickness="1"
                        CornerRadius="3">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock
                                Margin="0,0,5,0"
                                VerticalAlignment="Center"
                                FontWeight="Bold"
                                Text="Sub:" />
                            <CheckBox
                                Margin="0,0,10,0"
                                VerticalAlignment="Center"
                                Content="Tiếng Việt"
                                IsChecked="{Binding IsSubVi}" />
                            <CheckBox
                                VerticalAlignment="Center"
                                Content="English"
                                IsChecked="{Binding IsSubEn}" />
                        </StackPanel>
                    </Border>

                    <!--<TextBlock Text="Cookies:" VerticalAlignment="Center"/>
                    <TextBox Text="{Binding CookieFilePath}" Width="100" IsReadOnly="True" VerticalAlignment="Center" Margin="5,0"/>-->
                    <Border
                        Padding="5,2"
                        VerticalAlignment="Center"
                        Background="#FAFAFA"
                        BorderBrush="#BDBDBD"
                        BorderThickness="1"
                        CornerRadius="4">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock
                                Margin="0,0,5,0"
                                VerticalAlignment="Center"
                                FontWeight="SemiBold"
                                Text="🍪 Cookies:" />

                            <TextBox
                                Width="120"
                                Margin="0,0,5,0"
                                VerticalAlignment="Center"
                                Background="White"
                                BorderThickness="0"
                                FontStyle="Italic"
                                Foreground="Gray"
                                IsReadOnly="True"
                                Text="{Binding CookieFilePath}"
                                TextAlignment="Right"
                                ToolTip="{Binding CookieFilePath}" />

                            <Button
                                Margin="0,0,2,0"
                                Padding="8,2"
                                Background="White"
                                BorderBrush="Gray"
                                Command="{Binding SelectCookieFileCommand}"
                                ToolTip="Chọn file cookies có sẵn từ máy (.txt)">
                                <TextBlock FontWeight="Bold" Text="📂" />
                            </Button>

                            <Button
                                Padding="8,2"
                                Background="#FFEBEE"
                                BorderBrush="#EF9A9A"
                                Command="{Binding ClearCookiesCommand}"
                                ToolTip="Xóa cookies (Chuyển về chế độ tải thường)">
                                <TextBlock
                                    FontWeight="Bold"
                                    Foreground="#C62828"
                                    Text="❌" />
                            </Button>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <StackPanel Margin="0,5" Orientation="Horizontal">
                    <Button Command="{Binding UpdateToolsCommand}" Content="Cập nhật yt-dlp" />
                    <Button
                        Margin="10,0,0,0"
                        Command="{Binding CancelAllCommand}"
                        Content="Hủy Tất Cả"
                        Foreground="Red" />
                    <Button
                        Margin="20,0,0,0"
                        Command="{Binding OpenOutputFolderCommand}"
                        Content="📂 Mở Thư Mục Tải"
                        FontWeight="Bold" />
                </StackPanel>
            </StackPanel>
        </GroupBox>

        <DataGrid
            Grid.Row="2"
            Margin="0,10"
            AutoGenerateColumns="False"
            CanUserAddRows="False"
            GridLinesVisibility="Horizontal"
            HeadersVisibility="Column"
            ItemsSource="{Binding Downloads}">
            <DataGrid.Columns>
                <DataGridTextColumn
                    Width="300"
                    Binding="{Binding Title}"
                    Header="Video / URL" />
                <DataGridTextColumn
                    Width="120"
                    Binding="{Binding Status}"
                    Header="Trạng thái" />
                <DataGridTextColumn
                    Width="100"
                    Binding="{Binding Speed}"
                    Header="Tốc độ" />

                <DataGridTemplateColumn Width="*" Header="Tiến độ">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Grid>
                                <ProgressBar
                                    Height="18"
                                    Maximum="100"
                                    Value="{Binding Progress}" />
                                <TextBlock
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    FontSize="10"
                                    Text="{Binding Progress, StringFormat={}{0:0}%}" />
                            </Grid>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTemplateColumn Header="Action" Width="70">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Button Content="Stop" 
                    Command="{Binding DataContext.CancelItemCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                    CommandParameter="{Binding}" 
                    Foreground="Red"
                    Visibility="{Binding IsDownloading, Converter={StaticResource BoolToVis}}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <StatusBar Grid.Row="3" Padding="5">
            <StatusBarItem>
                <TextBlock
                    Width="400"
                    Text="{Binding LogMessage}"
                    TextTrimming="CharacterEllipsis" />
            </StatusBarItem>

            <StatusBarItem HorizontalAlignment="Right">
                <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" />
            </StatusBarItem>

            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <TextBlock
                        Margin="0,0,10,0"
                        VerticalAlignment="Center"
                        FontWeight="Bold"
                        Text="{Binding TotalStatusInfo}" />
                    <ProgressBar
                        Width="150"
                        Height="15"
                        Value="{Binding TotalProgressValue}" />
                </StackPanel>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>