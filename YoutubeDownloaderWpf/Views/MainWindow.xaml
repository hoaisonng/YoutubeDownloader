<Window x:Class="YoutubeDownloaderWpf.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:md="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:vm="clr-namespace:YoutubeDownloaderWpf.ViewModels"
        mc:Ignorable="d"
        Title="Youtube Downloader Pro" Height="700" Width="1400"
        WindowStartupLocation="CenterScreen"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        Background="{DynamicResource MaterialDesignPaper}"
        FontFamily="{DynamicResource MaterialDesignFont}">

    <!-- === PHẦN QUAN TRỌNG VỪA THÊM ĐỂ SỬA LỖI === -->
    <Window.Resources>
        <!-- Khai báo bộ chuyển đổi True/False thành Ẩn/Hiện -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </Window.Resources>
    <!-- =========================================== -->

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 1. HEADER & INPUT -->
        <md:ColorZone Mode="PrimaryMid" Padding="16" Grid.Row="0" Effect="{DynamicResource MaterialDesignShadowDepth2}">
            <DockPanel>
                <TextBlock Text="YT DOWNLOADER" VerticalAlignment="Center" Margin="0,0,20,0" FontWeight="Bold" FontSize="18"/>

                <Button Command="{Binding DownloadMissingToolsCommand}" 
                        Visibility="{Binding AreToolsMissing, Converter={StaticResource BooleanToVisibilityConverter}}"
                        Style="{StaticResource MaterialDesignRaisedButton}" 
                        md:ButtonAssist.CornerRadius="15"
                        Content="TẢI TOOLS" DockPanel.Dock="Right" Margin="10,0"/>

                <Button Command="{Binding AddDownloadCommand}" IsDefault="True"
                        Style="{StaticResource MaterialDesignFloatingActionMiniButton}" 
                        DockPanel.Dock="Right" Margin="10,0,0,0">
                    <md:PackIcon Kind="Plus" Width="24" Height="24"/>
                </Button>

                <TextBox Text="{Binding InputUrl, UpdateSourceTrigger=PropertyChanged}"
                         md:HintAssist.Hint="Dán link Youtube vào đây..."
                         Style="{StaticResource MaterialDesignFloatingHintTextBox}"
                         Foreground="White" CaretBrush="White" FontSize="14" VerticalAlignment="Center"/>
            </DockPanel>
        </md:ColorZone>

        <!-- 2. TOOLBAR CÀI ĐẶT -->
        <Grid Grid.Row="1" Margin="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">

                <Button Style="{StaticResource MaterialDesignOutlinedButton}" Command="{Binding ChangeOutputFolderCommand}" ToolTip="Đổi thư mục lưu" Margin="0,0,10,0">
                    <StackPanel Orientation="Horizontal">
                        <md:PackIcon Kind="FolderOpen" Margin="0,0,8,0"/>
                        <TextBlock Text="{Binding OutputFolderPath}" MaxWidth="200" TextTrimming="CharacterEllipsis"/>
                    </StackPanel>
                </Button>

                <CheckBox IsChecked="{Binding IsAudioOnly}" Content="Chỉ tải MP3" ToolTip="Audio Only" Margin="0,0,10,0"/>
                <!-- MỚI: Checkbox dịch thuật -->
                <CheckBox IsChecked="{Binding IsAutoTranslate}" Content="Dịch tên sang Anh" ToolTip="Tự động dịch tiêu đề video sang tiếng Anh" Margin="0,0,10,0"/>
                <CheckBox IsChecked="{Binding IsSubVi}" Content="Sub Việt" Margin="0,0,10,0"/>
                <CheckBox IsChecked="{Binding IsSubEn}" Content="Sub Anh" Margin="0,0,10,0"/>

                <md:PopupBox StaysOpen="True" ToolTip="Cài đặt Cookies" Margin="0,0,10,0">
                    <md:PopupBox.ToggleContent>
                        <StackPanel Orientation="Horizontal">
                            <md:PackIcon Kind="Cookie"/>
                            <TextBlock Text="Cookies" Margin="5,0"/>
                        </StackPanel>
                    </md:PopupBox.ToggleContent>
                    <StackPanel Width="200" Margin="10">
                        <Button Command="{Binding OpenLoginCommand}" Content="Đăng nhập Web"/>
                        <Button Command="{Binding ClearCookiesCommand}" Content="Xóa Cookies" Margin="0,5" Style="{StaticResource MaterialDesignOutlinedButton}"/>
                        <TextBlock Text="{Binding CookieFilePath}" TextWrapping="Wrap" FontSize="10" Opacity="0.6"/>
                    </StackPanel>
                </md:PopupBox>

                <Button Command="{Binding OpenPlaylistCommand}" Style="{StaticResource MaterialDesignFlatButton}" Content="Quét Playlist"/>
                <!-- Nút Cập nhật Mới -->
                <Button Command="{Binding UpdateToolsCommand}" 
        Style="{StaticResource MaterialDesignOutlinedButton}" 
        Content="Cập nhật yt-dlp" 
        Margin="10,0,0,0"
        ToolTip="Bấm vào đây nếu gặp lỗi 'n challenge' hoặc tải thất bại"/>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <Button Command="{Binding OpenOutputFolderCommand}" Content="Mở thư mục" Style="{StaticResource MaterialDesignFlatButton}"/>
                <Button Command="{Binding CancelAllCommand}" Content="Hủy tất cả" Foreground="Red" Style="{StaticResource MaterialDesignFlatButton}"/>
            </StackPanel>
        </Grid>

        <!-- 3. DANH SÁCH TẢI -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
            <Border Padding="10">
                <ItemsControl ItemsSource="{Binding Downloads}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <md:Card Margin="0,0,0,10" Padding="10">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="120"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <Border CornerRadius="4" ClipToBounds="True" Background="#EEE">
                                        <Image Source="{Binding ThumbnailUrl}" Stretch="UniformToFill"/>
                                    </Border>
                                    <Border Background="Black" Opacity="0.7" VerticalAlignment="Bottom" HorizontalAlignment="Right" CornerRadius="2" Margin="4">
                                        <TextBlock Text="{Binding Duration}" Foreground="White" FontSize="10" Padding="2"/>
                                    </Border>

                                    <StackPanel Grid.Column="1" Margin="10,0">
                                        <TextBlock Text="{Binding Title}" FontWeight="Bold" TextTrimming="CharacterEllipsis"/>
                                        <TextBlock Text="{Binding Url}" FontSize="10" Opacity="0.5" TextTrimming="CharacterEllipsis"/>

                                        <Grid Margin="0,8">
                                            <ProgressBar Value="{Binding Progress}" Maximum="100" Height="10" 
                                                         Style="{StaticResource MaterialDesignLinearProgressBar}"
                                                         Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                            <TextBlock Text="{Binding Status}" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="10"/>
                                        </Grid>

                                        <TextBlock Text="{Binding Speed}" FontSize="11" Foreground="Green"/>
                                    </StackPanel>

                                    <Button Grid.Column="2" 
                                            Command="{Binding DataContext.CancelItemCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}" 
                                            CommandParameter="{Binding}"
                                            Style="{StaticResource MaterialDesignIconForegroundButton}"
                                            Visibility="{Binding IsDownloading, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <md:PackIcon Kind="StopCircleOutline" Foreground="Red" Width="30" Height="30"/>
                                    </Button>
                                </Grid>
                            </md:Card>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Border>
        </ScrollViewer>

        <!-- 4. FOOTER STATUS -->
        <StatusBar Grid.Row="3" Padding="10">
            <TextBox Text="{Binding LogMessage}" FontWeight="Bold" TextWrapping="WrapWithOverflow"/>
            <Separator/>
            <TextBlock Text="{Binding TotalStatusInfo}"/>
            <Separator/>
            <ProgressBar Width="100" Height="10" Value="{Binding TotalProgressValue}"/>

            <StackPanel Orientation="Horizontal" Visibility="{Binding IsBusyWithTools, Converter={StaticResource BooleanToVisibilityConverter}}">
                <TextBlock Text="Đang tải tool:" Margin="10,0"/>
                <ProgressBar Width="100" Height="10" Value="{Binding ToolDownloadProgress}"/>
            </StackPanel>
        </StatusBar>
    </Grid>
</Window>