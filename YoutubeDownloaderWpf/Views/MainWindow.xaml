<Window
    x:Class="YoutubeDownloaderWpf.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:YoutubeDownloaderWpf.ViewModels"
    Title="Youtube Downloader Pro"
    Width="950"
    Height="650"
    mc:Ignorable="d">

    <d:Window.DataContext>
        <vm:MainViewModel />
    </d:Window.DataContext>

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
    </Window.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Border
            Grid.Row="0"
            Margin="0,0,0,10"
            Padding="10"
            Background="#FFF4E5"
            BorderBrush="#FFCC80"
            BorderThickness="1"
            CornerRadius="5"
            Visibility="{Binding AreToolsMissing, Converter={StaticResource BoolToVis}}">
            <StackPanel>
                <TextBlock
                    Margin="0,0,0,5"
                    FontWeight="Bold"
                    Foreground="#D32F2F"
                    Text="⚠️ CẢNH BÁO: Ứng dụng thiếu các file thư viện cần thiết để chạy!" />
                <TextBlock Margin="0,0,0,10" Text="{Binding ToolStatusMessage}" />

                <StackPanel Orientation="Horizontal">
                    <Button
                        Margin="0,0,10,0"
                        Padding="10,5"
                        Background="#4CAF50"
                        Command="{Binding DownloadMissingToolsCommand}"
                        Content="Tải Tự Động (Khuyên dùng)"
                        FontWeight="Bold"
                        Foreground="White" />

                    <TextBlock
                        Margin="10,0,5,0"
                        VerticalAlignment="Center"
                        Text="Hoặc chọn file có sẵn:" />
                    <Button
                        Margin="5,0"
                        Command="{Binding LocateYtDlpCommand}"
                        Content="Chọn yt-dlp.exe" />
                    <Button
                        Margin="5,0"
                        Command="{Binding LocateFfmpegCommand}"
                        Content="Chọn ffmpeg.exe" />
                </StackPanel>

                <ProgressBar
                    Height="5"
                    Margin="0,10,0,0"
                    Maximum="100"
                    Visibility="{Binding IsBusyWithTools, Converter={StaticResource BoolToVis}}"
                    Value="{Binding ToolDownloadProgress}" />
            </StackPanel>
        </Border>

        <GroupBox Grid.Row="1" Header="Cấu hình tải" Padding="10">
            <StackPanel>
                <Grid Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBox Grid.Column="0" Text="{Binding InputUrl, UpdateSourceTrigger=PropertyChanged}" 
                             FontSize="14" Padding="5" ToolTip="Link Video/Playlist"/>
                    <Button Grid.Column="1" Content="Thêm vào hàng đợi" Width="120" Command="{Binding AddDownloadCommand}" 
                            Margin="10,0,0,0" Padding="15,5" FontWeight="Bold"/>
                </Grid>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <TextBlock Text="Lưu tại:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <TextBox Text="{Binding OutputFolderPath}" Width="150" IsReadOnly="True" VerticalAlignment="Center" Padding="3"/>
                    <Button Content="..." Command="{Binding ChangeOutputFolderCommand}" Width="30" Margin="2,0,15,0"/>

                    <TextBlock Text="Cookies:" VerticalAlignment="Center" Margin="0,0,5,0" FontWeight="Bold"/>
                    <TextBox Text="{Binding CookieFilePath}" Width="150" IsReadOnly="True" VerticalAlignment="Center" Padding="3" ToolTip="File cookies.txt"/>
                    <Button Content="..." Command="{Binding SelectCookieFileCommand}" Width="30" Margin="2,0,0,0" ToolTip="Chọn file cookies.txt"/>
                    <Button Content="X" Command="{Binding ClearCookiesCommand}" Width="20" Margin="2,0,15,0" Background="#FFEBEE" Foreground="Red" FontWeight="Bold" ToolTip="Xóa cookies"/>

                    <CheckBox Content="Sub Việt" IsChecked="{Binding IsSubVi}" VerticalAlignment="Center" Margin="0,0,10,0"/>
                    <CheckBox Content="Sub Anh" IsChecked="{Binding IsSubEn}" VerticalAlignment="Center"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,5">
                    <Button Content="Mở Thư Mục" Command="{Binding OpenOutputFolderCommand}" Margin="0,0,10,0"/>
                    <Button Content="Update yt-dlp" Command="{Binding UpdateToolsCommand}" />
                    <Button Content="Hủy Tất Cả" Command="{Binding CancelAllCommand}" Margin="10,0,0,0" Foreground="Red"/>
                </StackPanel>
            </StackPanel>
        </GroupBox>

        <DataGrid
            Grid.Row="2"
            Margin="0,10"
            AutoGenerateColumns="False"
            CanUserAddRows="False"
            GridLinesVisibility="Horizontal"
            HeadersVisibility="Column"
            ItemsSource="{Binding Downloads}">
            <DataGrid.Columns>
                <DataGridTextColumn
                    Width="300"
                    Binding="{Binding Title}"
                    Header="Video / URL" />
                <DataGridTextColumn
                    Width="120"
                    Binding="{Binding Status}"
                    Header="Trạng thái" />
                <DataGridTextColumn
                    Width="100"
                    Binding="{Binding Speed}"
                    Header="Tốc độ" />

                <DataGridTemplateColumn Width="*" Header="Tiến độ">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Grid>
                                <ProgressBar
                                    Height="18"
                                    Maximum="100"
                                    Value="{Binding Progress}" />
                                <TextBlock
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    FontSize="10"
                                    Text="{Binding Progress, StringFormat={}{0:0}%}" />
                            </Grid>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTemplateColumn Header="Action" Width="70">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Button Content="Stop" 
                    Command="{Binding DataContext.CancelItemCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                    CommandParameter="{Binding}" 
                    Foreground="Red"
                    Visibility="{Binding IsDownloading, Converter={StaticResource BoolToVis}}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <StatusBar Grid.Row="3" Padding="5">
            <StatusBarItem>
                <TextBox
                    Width="400"
                    Text="{Binding LogMessage}"
                    TextWrapping="WrapWithOverflow" />
            </StatusBarItem>

            <StatusBarItem HorizontalAlignment="Right">
                <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" />
            </StatusBarItem>

            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <TextBlock
                        Margin="0,0,10,0"
                        VerticalAlignment="Center"
                        FontWeight="Bold"
                        Text="{Binding TotalStatusInfo}" />
                    <ProgressBar
                        Width="150"
                        Height="15"
                        Value="{Binding TotalProgressValue}" />
                </StackPanel>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>